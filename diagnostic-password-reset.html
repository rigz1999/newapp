<!DOCTYPE html>
<html>
<head>
  <title>Password Reset Diagnostic Tool</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #1e40af;
      margin-bottom: 20px;
    }
    .test-section {
      margin: 20px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 5px;
    }
    input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin: 10px 0;
      font-size: 14px;
    }
    button {
      background: #2563eb;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      margin: 10px 5px 10px 0;
    }
    button:hover {
      background: #1d4ed8;
    }
    button:disabled {
      background: #94a3b8;
      cursor: not-allowed;
    }
    .log-section {
      margin-top: 20px;
      padding: 15px;
      background: #1e293b;
      color: #f1f5f9;
      border-radius: 5px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 500px;
      overflow-y: auto;
    }
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid #3b82f6;
      padding-left: 10px;
    }
    .log-success {
      border-left-color: #10b981;
      color: #86efac;
    }
    .log-error {
      border-left-color: #ef4444;
      color: #fca5a5;
    }
    .log-info {
      border-left-color: #f59e0b;
      color: #fcd34d;
    }
    .config-section {
      background: #eff6ff;
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
    }
    .config-item {
      margin: 8px 0;
      font-size: 13px;
    }
    .config-label {
      font-weight: 600;
      color: #1e40af;
    }
    .config-value {
      color: #475569;
      font-family: 'Courier New', monospace;
      background: white;
      padding: 2px 6px;
      border-radius: 3px;
    }
    .clear-btn {
      background: #64748b;
      font-size: 12px;
      padding: 8px 16px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” Password Reset Diagnostic Tool</h1>

    <div class="config-section">
      <h3 style="margin-top: 0;">Configuration</h3>
      <div class="config-item">
        <span class="config-label">Supabase URL:</span>
        <span class="config-value" id="config-url">Not set</span>
      </div>
      <div class="config-item">
        <span class="config-label">Anon Key:</span>
        <span class="config-value" id="config-key">Not set</span>
      </div>
      <div class="config-item">
        <span class="config-label">Functions Endpoint:</span>
        <span class="config-value" id="config-functions">Not set</span>
      </div>
    </div>

    <div class="test-section">
      <h3 style="margin-top: 0;">Test Credentials</h3>
      <input
        type="text"
        id="supabase-url"
        placeholder="Supabase URL (e.g., https://xxx.supabase.co)"
        value=""
      />
      <input
        type="text"
        id="supabase-key"
        placeholder="Supabase Anon Key"
        value=""
      />
      <button onclick="initializeClient()">Initialize Client</button>
    </div>

    <div class="test-section">
      <h3 style="margin-top: 0;">Test Password Reset</h3>
      <input
        type="email"
        id="test-email"
        placeholder="Enter email to test"
      />
      <button onclick="testPasswordReset()" id="test-btn" disabled>Test Password Reset</button>
      <button onclick="testDirectAPI()" id="direct-test-btn" disabled>Test Direct API Call</button>
    </div>

    <div class="log-section">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <strong>Diagnostic Logs</strong>
        <button class="clear-btn" onclick="clearLogs()">Clear Logs</button>
      </div>
      <div id="logs"></div>
    </div>
  </div>

  <script>
    let supabaseClient = null;
    let supabaseUrl = '';
    let supabaseKey = '';

    function log(message, type = 'info') {
      const logsDiv = document.getElementById('logs');
      const timestamp = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;

      let icon = 'â„¹ï¸';
      if (type === 'success') icon = 'âœ…';
      if (type === 'error') icon = 'âŒ';

      entry.innerHTML = `<strong>[${timestamp}]</strong> ${icon} ${message}`;
      logsDiv.appendChild(entry);
      logsDiv.scrollTop = logsDiv.scrollHeight;
    }

    function clearLogs() {
      document.getElementById('logs').innerHTML = '';
      log('Logs cleared', 'info');
    }

    function initializeClient() {
      const url = document.getElementById('supabase-url').value.trim();
      const key = document.getElementById('supabase-key').value.trim();

      if (!url || !key) {
        log('Please enter both Supabase URL and Anon Key', 'error');
        return;
      }

      supabaseUrl = url;
      supabaseKey = key;

      try {
        supabaseClient = window.supabase.createClient(url, key);

        document.getElementById('config-url').textContent = url;
        document.getElementById('config-key').textContent = '***' + key.slice(-8);
        document.getElementById('config-functions').textContent = url + '/functions/v1';

        document.getElementById('test-btn').disabled = false;
        document.getElementById('direct-test-btn').disabled = false;

        log('Supabase client initialized successfully', 'success');
        log(`Functions endpoint: ${url}/functions/v1/send-password-reset`, 'info');
      } catch (error) {
        log(`Failed to initialize client: ${error.message}`, 'error');
      }
    }

    async function testPasswordReset() {
      const email = document.getElementById('test-email').value.trim();

      if (!email) {
        log('Please enter an email address', 'error');
        return;
      }

      if (!supabaseClient) {
        log('Please initialize the client first', 'error');
        return;
      }

      log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
      log(`Starting password reset test for: ${email}`, 'info');
      log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');

      try {
        log('Calling supabase.functions.invoke("send-password-reset")...', 'info');

        const startTime = Date.now();
        const { data, error } = await supabaseClient.functions.invoke('send-password-reset', {
          body: { email: email.toLowerCase().trim() }
        });
        const duration = Date.now() - startTime;

        log(`Request completed in ${duration}ms`, 'info');

        // Log raw response
        log('Raw response data: ' + JSON.stringify(data, null, 2), 'info');
        log('Raw response error: ' + JSON.stringify(error, null, 2), 'info');

        if (error) {
          log('Edge function returned error:', 'error');
          log(`Error name: ${error.name}`, 'error');
          log(`Error message: ${error.message}`, 'error');
          log(`Error context: ${JSON.stringify(error.context || {})}`, 'error');

          // Check for specific error types
          if (error.message?.includes('FunctionsRelayError')) {
            log('âš ï¸ DIAGNOSIS: Edge function is not responding (might not be deployed)', 'error');
          } else if (error.message?.includes('FunctionsHttpError')) {
            log('âš ï¸ DIAGNOSIS: Edge function returned an HTTP error', 'error');
          } else if (error.message?.includes('FunctionsFetchError')) {
            log('âš ï¸ DIAGNOSIS: Network error - cannot reach edge function', 'error');
          }
        } else if (data) {
          log('Edge function returned success:', 'success');
          log(`Success: ${data.success}`, 'success');
          log(`Message: ${data.message}`, 'success');

          if (data.success) {
            log('âœ… RESULT: Function executed successfully', 'success');
            log('âš ï¸ NOTE: Success message does not guarantee email was sent (security feature)', 'info');
            log('ğŸ“§ CHECK: Look at Supabase Edge Function logs to see if email was actually sent', 'info');
          }
        } else {
          log('âš ï¸ WARNING: No data or error returned', 'error');
        }

      } catch (err) {
        log('JavaScript exception caught:', 'error');
        log(`Exception type: ${err.name}`, 'error');
        log(`Exception message: ${err.message}`, 'error');
        log(`Exception stack: ${err.stack}`, 'error');
      }

      log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
    }

    async function testDirectAPI() {
      const email = document.getElementById('test-email').value.trim();

      if (!email) {
        log('Please enter an email address', 'error');
        return;
      }

      log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
      log('Testing direct API call (bypassing SDK)...', 'info');
      log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');

      const url = `${supabaseUrl}/functions/v1/send-password-reset`;

      try {
        log(`Fetching: ${url}`, 'info');

        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${supabaseKey}`,
            'apikey': supabaseKey
          },
          body: JSON.stringify({ email: email.toLowerCase().trim() })
        });

        log(`Response status: ${response.status} ${response.statusText}`, 'info');
        log(`Response headers: ${JSON.stringify(Object.fromEntries(response.headers.entries()), null, 2)}`, 'info');

        const contentType = response.headers.get('content-type');
        let responseData;

        if (contentType?.includes('application/json')) {
          responseData = await response.json();
          log(`Response body (JSON): ${JSON.stringify(responseData, null, 2)}`, 'info');
        } else {
          responseData = await response.text();
          log(`Response body (Text): ${responseData}`, 'info');
        }

        if (response.ok) {
          log('âœ… Direct API call successful', 'success');
        } else {
          log(`âŒ Direct API call failed with status ${response.status}`, 'error');
        }

      } catch (err) {
        log(`Network error: ${err.message}`, 'error');
        log('âš ï¸ DIAGNOSIS: Cannot reach the edge function endpoint', 'error');
      }

      log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
    }

    // Initialize with placeholder text
    log('Diagnostic tool ready. Enter your Supabase credentials and click "Initialize Client"', 'info');
  </script>
</body>
</html>
